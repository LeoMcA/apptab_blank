const widgets = require("widget");
const tabs = require("tabs");
const storage = require("simple-storage");
const parseUri = require("parseUri");

if (!storage.storage.blanks) storage.storage.blanks = [];

var blankIsOn = true;
 
function toggleActivation() {
	blankIsOn = !blankIsOn;
	return blankIsOn;
}

var widget = widgets.Widget({
	id: "apptab_blank",
	label: "Click here to toggle apptab_blank for this tab",
	content: " ",
	contentScriptWhen: "ready",
	contentScript: "self.on('click', self.port.emit('clicked'));",
	width: 50
});

function updateWidgetState(tab) {
	let view = widget.getView(tab.window);
	if (!view) return;
	view.content = tabs.activeTab.isPinned == true ? "Pinned" : "Unpinned";
	if (tabs.activeTab.isPinned == true) {
		storage.storage.blanks.forEach( function (element) {
			if (element == parseUri.parseUri(tabs.activeTab.url).host) {
				view.content = "Loaded";
			}
		});
	};
}

tabs.on('ready', updateWidgetState);
tabs.on('activate', updateWidgetState);

function removeByElement(arrayName,arrayElement) {
	for(var i=0; i<arrayName.length;i++ ) { 
		if(arrayName[i]==arrayElement) arrayName.splice(i,1); 
	}
}

widget.on("click", function () {
	if (tabs.activeTab.isPinned == true) {
		let view = widget.getView(tabs.activeTab.window);
		view.content = toggleActivation() ? "Deleted" : "Clicked";
		toggleActivation() ? removeByElement(storage.storage.blanks, parseUri.parseUri(tabs.activeTab.url).host) : storage.storage.blanks.push(parseUri.parseUri(tabs.activeTab.url).host);
	};
});
