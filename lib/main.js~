const widgets = require("widget");
const tabs = require("tabs");
const storage = require("simple-storage");
const parseUri = require("parseUri");

if (!storage.storage.blanks) storage.storage.blanks = [];

var blankIsOn = true;
 
function toggleActivation() {
	blankIsOn = !blankIsOn;
	return blankIsOn;
}

var widget = widgets.Widget({
	id: "apptab_blank",
	label: "Click here to toggle apptab_blank for this tab",
	content: " ",
	contentScriptWhen: "ready",
	contentScript: "self.on('click', self.port.emit('clicked'));",
	width: 50
});

function oc(a) {
  var o = {};
  for(var i=0;i<a.length;i++)
  {
    o[a[i]]='';
  }
  return o;
}

function updateWidgetState(tab) {
	let view = widget.getView(tab.window);
	if (!view) return;
	view.content = tabs.activeTab.isPinned == true ? "Pinned" : "Unpinned";
	if(storage.storage.blanks in oc(tabs.activeTab.url)) {
		view.content = "works";
	}
}

tabs.on('ready', updateWidgetState);
tabs.on('activate', updateWidgetState);


widget.on("click", function () {
	if (tabs.activeTab.isPinned == true) {
		let view = widget.getView(tabs.activeTab.window);
		view.content = toggleActivation() ? "Pinned" : "Clicked";
		storage.storage.blanks.push(parseUri.parseUri(tabs.activeTab.url).host);
	};
});
